<?xml version="1.0" encoding="UTF-8"?>
<story-context id="2-10-auth-navigation-flow" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.10</storyId>
    <title>Auth Navigation Flow</title>
    <status>drafted</status>
    <generatedAt>2025-11-06</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-10-auth-navigation-flow.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>user</asA>
    <iWant>automatic navigation based on auth status</iWant>
    <soThat>I'm directed to login or home screen appropriately</soThat>
    <tasks>
      <task n="1">Verify Root Layout Auth Check Implementation (AC: #1)</task>
      <task n="2">Implement Authentication-Based Routing (AC: #2, #3, #4)</task>
      <task n="3">Implement Post-Login/Register Navigation (AC: #5)</task>
      <task n="4">Implement Post-Logout Navigation (AC: #6)</task>
      <task n="5">Implement Loading State (AC: #8)</task>
      <task n="6">Handle Deep Linking (AC: #7)</task>
      <task n="7">Test App Reload Behavior (AC: #9)</task>
      <task n="8">Integration Testing (AC: all)</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion n="1">Root layout checks auth status on app load using checkAuth()</criterion>
    <criterion n="2">If not authenticated → show auth screens (login/register)</criterion>
    <criterion n="3">If authenticated → show main tabs (home, history, profile)</criterion>
    <criterion n="4">Protected screens require authentication</criterion>
    <criterion n="5">After login/register → automatic navigation to home</criterion>
    <criterion n="6">After logout → automatic navigation to login</criterion>
    <criterion n="7">Deep linking respects auth state</criterion>
    <criterion n="8">Smooth transitions (no flashing of wrong screen)</criterion>
    <criterion n="9">Works correctly on app reload</criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Story 2.10: Auth Navigation Flow</section>
        <snippet>Root layout checks auth status on app load. If not authenticated → show auth screens. If authenticated → show main tabs. After login/register → auto-navigate to home. After logout → auto-navigate to login.</snippet>
      </doc>
      <doc>
        <path>docs/stories/2-9-profile-screen-ui.md</path>
        <title>Previous Story Implementation</title>
        <section>Dev Agent Record - Root Layout Implementation Already Complete</section>
        <snippet>Root layout (_layout.tsx) implemented with auth checking, checkAuth() on mount, automatic navigation based on isAuthenticated state. Navigation handled centrally without manual redirects.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>Authentication Flow and Navigation</section>
        <snippet>Auth flow uses Zustand store for state management. Root layout uses useSegments to detect current route and redirect based on authentication status.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>mobile/src/app/_layout.tsx</path>
        <kind>layout</kind>
        <symbol>RootLayout</symbol>
        <lines>1-75</lines>
        <reason>Main implementation already complete - handles auth-based routing, calls checkAuth() on mount, shows loading screen, manages transitions between auth/tabs</reason>
      </artifact>
      <artifact>
        <path>mobile/src/stores/useAuthStore.ts</path>
        <kind>service</kind>
        <symbol>useAuthStore</symbol>
        <lines>91-250</lines>
        <reason>Zustand auth store provides isAuthenticated, isLoading, checkAuth() methods required for root layout navigation logic</reason>
      </artifact>
      <artifact>
        <path>mobile/src/app/(auth)/_layout.tsx</path>
        <kind>layout</kind>
        <symbol>AuthLayout</symbol>
        <lines>1-18</lines>
        <reason>Auth screens group (login/register) - should only be shown when not authenticated per root layout routing</reason>
      </artifact>
      <artifact>
        <path>mobile/src/app/(tabs)/_layout.tsx</path>
        <kind>layout</kind>
        <symbol>TabsLayout</symbol>
        <lines>1-70</lines>
        <reason>Protected tabs group (home, history, profile) - should only be shown when authenticated per root layout routing</reason>
      </artifact>
      <artifact>
        <path>mobile/src/app/(auth)/login.tsx</path>
        <kind>component</kind>
        <symbol>LoginScreen</symbol>
        <lines>40-150</lines>
        <reason>Login screen - manual navigation removed, relies on root layout for post-login redirect</reason>
      </artifact>
      <artifact>
        <path>mobile/src/app/(auth)/register.tsx</path>
        <kind>component</kind>
        <symbol>RegisterScreen</symbol>
        <lines>60-250</lines>
        <reason>Register screen - manual navigation removed, relies on root layout for post-register redirect</reason>
      </artifact>
    </code>
    <dependencies>
      <dependency>
        <ecosystem>npm</ecosystem>
        <package>expo-router</package>
        <version>^6.0.14</version>
        <reason>File-based routing, useRouter, useSegments hooks for navigation</reason>
      </dependency>
      <dependency>
        <ecosystem>npm</ecosystem>
        <package>zustand</package>
        <version>^5.0.8</version>
        <reason>Auth store state management - isAuthenticated, isLoading, checkAuth</reason>
      </dependency>
      <dependency>
        <ecosystem>npm</ecosystem>
        <package>react</package>
        <version>19.1.0</version>
        <reason>useEffect, useState for auth flow management</reason>
      </dependency>
      <dependency>
        <ecosystem>npm</ecosystem>
        <package>react-native</package>
        <version>0.81.5</version>
        <reason>ActivityIndicator for loading screen, View for layout</reason>
      </dependency>
      <dependency>
        <ecosystem>npm</ecosystem>
        <package>expo</package>
        <version>~54.0.22</version>
        <reason>Expo SDK for native module support</reason>
      </dependency>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="pattern">
      <name>Auth-Based Routing</name>
      <description>Root layout must check isAuthenticated and show appropriate screen group. No manual navigation from login/register screens. Auth state changes trigger automatic redirects.</description>
      <source>mobile/src/app/_layout.tsx</source>
    </constraint>
    <constraint type="pattern">
      <name>Token Restoration</name>
      <description>checkAuth() must be called on app initialization to restore token from storage. This ensures user stays logged in on app reload.</description>
      <source>mobile/src/stores/useAuthStore.ts line 217-249</source>
    </constraint>
    <constraint type="pattern">
      <name>Loading State Management</name>
      <description>Show loading screen while isLoading is true to prevent flash of wrong screen during auth check. Only perform redirects after auth check completes.</description>
      <source>mobile/src/app/_layout.tsx line 40-57</source>
    </constraint>
    <constraint type="requirement">
      <name>Deep Linking</name>
      <description>Deep links must respect auth state - if user not authenticated and tries to access protected route, redirect to login first, then navigate to deep link after login.</description>
      <source>docs/epics.md#Story-2.10 AC7</source>
    </constraint>
    <constraint type="testing">
      <name>Cross-Platform Testing</name>
      <description>Test auth navigation on web, iOS, and Android platforms. Verify smooth transitions and no screen flashing on all platforms.</description>
      <source>docs/stories/2-9-profile-screen-ui.md Testing Checklist</source>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>useAuthStore()</name>
      <kind>Zustand Hook</kind>
      <signature>const { isAuthenticated, isLoading, checkAuth, login, logout, user } = useAuthStore()</signature>
      <path>mobile/src/stores/useAuthStore.ts line 91</path>
      <description>Auth state management hook. Required properties for navigation: isAuthenticated (boolean), isLoading (boolean), checkAuth (async function)</description>
    </interface>
    <interface>
      <name>useRouter()</name>
      <kind>Expo Router Hook</kind>
      <signature>const router = useRouter(); router.replace(path: string)</signature>
      <path>expo-router</path>
      <description>Navigation hook from Expo Router. Use replace() to navigate without allowing back button.</description>
    </interface>
    <interface>
      <name>useSegments()</name>
      <kind>Expo Router Hook</kind>
      <signature>const segments = useSegments(); // returns string[]</signature>
      <path>expo-router</path>
      <description>Hook to detect current route segments. Used to check if user in auth group or tabs group.</description>
    </interface>
    <interface>
      <name>checkAuth()</name>
      <kind>Auth Store Method</kind>
      <signature>async checkAuth(): Promise<void></signature>
      <path>mobile/src/stores/useAuthStore.ts line 217</path>
      <description>Restores auth session from token in storage. Calls /api/v1/auth/me endpoint to validate token. Sets user data if valid, clears if invalid.</description>
    </interface>
  </interfaces>

  <tests>
    <standards>
      <standard>Testing framework: Jest with @testing-library/react-native for component tests. Integration tests for navigation flows using mocked auth store and router. Mock Zustand store to control isAuthenticated/isLoading states. Mock useRouter and useSegments from expo-router for testing redirect logic. Test both success and error paths.</standard>
    </standards>
    <locations>
      <location>mobile/__tests__/app/ - Root layout and navigation tests</location>
      <location>mobile/__tests__/stores/ - Auth store tests (checkAuth, login, logout)</location>
      <location>mobile/__tests__/screens/ - Integration tests for auth flow</location>
    </locations>
    <ideas>
      <idea acId="1">Test that checkAuth() is called when RootLayout mounts</idea>
      <idea acId="2,3">Test navigation to login screen when not authenticated, tabs when authenticated</idea>
      <idea acId="5,6">Test automatic redirect after login success and logout</idea>
      <idea acId="7">Test deep link handling - redirect to login if not auth, then to original link</idea>
      <idea acId="8">Test smooth transitions - no ActivityIndicator flash, proper loading state</idea>
      <idea acId="9">Test app reload with valid token in storage - should stay logged in</idea>
      <idea acId="9">Test app reload with invalid token - should redirect to login</idea>
      <idea acId="all">Integration test: full flow open → login → navigate → logout</idea>
      <idea acId="all">Test navigation doesn't loop infinitely</idea>
      <idea acId="all">Test works on web, iOS, Android platforms</idea>
    </ideas>
  </tests>
</story-context>
