<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2</storyId>
    <title>Password Hashing & Security Utilities</title>
    <status>drafted</status>
    <generatedAt>2025-11-05</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-2-password-hashing-security-utilities.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>backend developer</asA>
    <iWant>secure password hashing utilities</iWant>
    <soThat>I can safely store and verify user passwords</soThat>
    <tasks>
      <task id="1" mapped-to="AC1,AC6">
        <description>Create Security Module File</description>
        <subtasks>
          <subtask>Create backend/src/core/security.py file</subtask>
          <subtask>Import required dependencies: bcrypt, python-jose[cryptography], datetime, os</subtask>
          <subtask>Define module-level constants: JWT_SECRET, ALGORITHM, ACCESS_TOKEN_EXPIRE_MINUTES</subtask>
          <subtask>Add module docstring explaining security utilities</subtask>
        </subtasks>
      </task>
      <task id="2" mapped-to="AC2,AC3">
        <description>Implement Password Hashing Functions</description>
        <subtasks>
          <subtask>Implement hash_password(password: str) -> str function with bcrypt cost factor 12</subtask>
          <subtask>Implement verify_password(plain_password: str, hashed_password: str) -> bool function</subtask>
          <subtask>Add comprehensive docstrings and type hints</subtask>
        </subtasks>
      </task>
      <task id="3" mapped-to="AC4,AC5">
        <description>Implement JWT Token Functions</description>
        <subtasks>
          <subtask>Implement create_access_token(data: dict, expires_delta: timedelta | None = None) -> str</subtask>
          <subtask>Implement verify_access_token(token: str) -> dict | None</subtask>
          <subtask>Add comprehensive docstrings and type hints</subtask>
        </subtasks>
      </task>
      <task id="4" mapped-to="AC6">
        <description>Update Settings Configuration</description>
        <subtasks>
          <subtask>Edit backend/src/core/settings.py</subtask>
          <subtask>Add JWT_SECRET to Settings class with secure default</subtask>
        </subtasks>
      </task>
      <task id="5" mapped-to="AC7">
        <description>Create Unit Tests</description>
        <subtasks>
          <subtask>Create backend/tests/core/ directory structure</subtask>
          <subtask>Create backend/tests/core/test_security.py</subtask>
          <subtask>Write TestPasswordHashing class with 5+ tests</subtask>
          <subtask>Write TestJWTTokens class with 6+ tests</subtask>
        </subtasks>
      </task>
      <task id="6" mapped-to="AC7,AC8">
        <description>Run Tests and Verify</description>
        <subtasks>
          <subtask>Run pytest tests/core/test_security.py -v</subtask>
          <subtask>Verify all tests pass</subtask>
          <subtask>Check code coverage >90%</subtask>
        </subtasks>
      </task>
      <task id="7" mapped-to="AC8">
        <description>Integration Testing</description>
        <subtasks>
          <subtask>Test import in Python REPL</subtask>
          <subtask>Test hash_password with sample password</subtask>
          <subtask>Test verify_password with hashed result</subtask>
          <subtask>Test create_access_token with sample data</subtask>
          <subtask>Test verify_access_token with generated token</subtask>
        </subtasks>
      </task>
      <task id="8" mapped-to="All ACs">
        <description>Documentation</description>
        <subtasks>
          <subtask>Add docstrings to all functions</subtask>
          <subtask>Update architecture.md if security patterns changed</subtask>
          <subtask>Document JWT secret management</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">
      <title>Security Module Created</title>
      <items>
        <item>File backend/src/core/security.py exists</item>
        <item>Module imports all required dependencies (bcrypt, python-jose, datetime)</item>
        <item>Module follows project coding standards</item>
      </items>
    </criterion>
    <criterion id="AC2">
      <title>Password Hashing Function</title>
      <items>
        <item>hash_password(password: str) -> str function implemented</item>
        <item>Uses bcrypt with cost factor 12</item>
        <item>Returns UTF-8 encoded hash string</item>
        <item>Handles edge cases (empty password, special characters)</item>
        <item>Function has comprehensive docstring</item>
      </items>
    </criterion>
    <criterion id="AC3">
      <title>Password Verification Function</title>
      <items>
        <item>verify_password(plain_password: str, hashed_password: str) -> bool function implemented</item>
        <item>Correctly verifies matching passwords</item>
        <item>Returns False for non-matching passwords</item>
        <item>Handles edge cases (None values, empty strings)</item>
        <item>Function has comprehensive docstring</item>
      </items>
    </criterion>
    <criterion id="AC4">
      <title>JWT Token Creation Function</title>
      <items>
        <item>create_access_token(data: dict, expires_delta: timedelta | None = None) -> str function implemented</item>
        <item>Uses JWT with HS256 algorithm</item>
        <item>Reads JWT_SECRET from environment variable</item>
        <item>Default expiry: 15 minutes</item>
        <item>Includes 'exp' claim in token payload</item>
        <item>Function has comprehensive docstring</item>
      </items>
    </criterion>
    <criterion id="AC5">
      <title>JWT Token Verification Function</title>
      <items>
        <item>verify_access_token(token: str) -> dict | None function implemented</item>
        <item>Successfully decodes valid tokens</item>
        <item>Returns None for invalid/expired tokens</item>
        <item>Handles JWTError exceptions gracefully</item>
        <item>Function has comprehensive docstring</item>
      </items>
    </criterion>
    <criterion id="AC6">
      <title>Environment Configuration</title>
      <items>
        <item>JWT_SECRET environment variable configured</item>
        <item>Settings.py includes JWT_SECRET with secure default for dev</item>
        <item>ACCESS_TOKEN_EXPIRE_MINUTES constant defined (15 minutes)</item>
        <item>ALGORITHM constant defined ("HS256")</item>
      </items>
    </criterion>
    <criterion id="AC7">
      <title>Unit Tests Created</title>
      <items>
        <item>Test file backend/tests/core/test_security.py exists</item>
        <item>Tests for hash_password (valid, empty, special chars)</item>
        <item>Tests for verify_password (match, mismatch, edge cases)</item>
        <item>Tests for create_access_token (default expiry, custom expiry)</item>
        <item>Tests for verify_access_token (valid, expired, invalid)</item>
        <item>All tests pass: uv run pytest tests/core/test_security.py</item>
      </items>
    </criterion>
    <criterion id="AC8">
      <title>Integration with Existing Code</title>
      <items>
        <item>Security functions can be imported: from src.core.security import ...</item>
        <item>Functions work with User model's hashed_password field</item>
        <item>No conflicts with existing core modules</item>
      </items>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic 2 - Story 2.2</title>
        <section>Story 2.2: Password Hashing & Security Utilities</section>
        <snippet>Security utilities for bcrypt password hashing (cost factor 12) and JWT token generation (HS256, 15 min expiry). Includes hash_password, verify_password, create_access_token, verify_access_token functions with comprehensive unit tests.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture - Security Decisions</title>
        <section>Decision Summary - Authentication</section>
        <snippet>Password Hashing: bcrypt with cost factor 12 for industry-standard security. JWT Tokens: HS256 algorithm, 15 minute access token lifetime, JWT_SECRET from environment. Token payload should contain minimal data (user ID only).</snippet>
      </doc>
      <doc>
        <path>docs/stories/2-1-user-model-database-schema.md</path>
        <title>Previous Story - User Model</title>
        <section>Dev Agent Record - Completion Notes</section>
        <snippet>User model created with hashed_password field (nullable for OAuth). Database migration applied successfully. Password hashing will be implemented in Story 2.2 (this story). User table ready in PostgreSQL.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>backend/src/models/user.py</path>
        <kind>model</kind>
        <symbol>User.hashed_password</symbol>
        <lines>45-48</lines>
        <reason>Security functions will work with User model's hashed_password field (str | None). Nullable for OAuth users. hash_password() output will be stored here.</reason>
      </artifact>
      <artifact>
        <path>backend/src/core/settings.py</path>
        <kind>configuration</kind>
        <symbol>Settings</symbol>
        <lines>22-186</lines>
        <reason>Pattern to follow for adding JWT_SECRET configuration. Uses Pydantic BaseSettings with env_file support. Shows existing database_url, redis_url pattern to replicate for JWT config.</reason>
      </artifact>
      <artifact>
        <path>backend/src/core/database.py</path>
        <kind>core-module</kind>
        <symbol>get_session</symbol>
        <lines>30-52</lines>
        <reason>Example of existing core module pattern. Shows docstring style, function structure, and import patterns to follow for security.py module.</reason>
      </artifact>
      <artifact>
        <path>backend/pyproject.toml</path>
        <kind>dependencies</kind>
        <symbol>dependencies</symbol>
        <lines>7-18</lines>
        <reason>bcrypt>=4.1.0 and python-jose[cryptography]>=3.3.0 already installed. No additional dependencies needed for this story.</reason>
      </artifact>
    </code>
    <dependencies>
      <python>
        <package name="bcrypt" version=">=4.1.0" status="installed">Password hashing library - already in pyproject.toml</package>
        <package name="python-jose[cryptography]" version=">=3.3.0" status="installed">JWT token library - already in pyproject.toml</package>
        <package name="pytest" version=">=7.4.0" status="installed">Testing framework - already in dev dependencies</package>
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="security">NEVER store plain text passwords. Always use bcrypt hashing with cost factor 12.</constraint>
    <constraint type="security">JWT_SECRET must be loaded from environment variable, never hardcoded in production.</constraint>
    <constraint type="architecture">Follow existing core module pattern from backend/src/core/database.py and settings.py.</constraint>
    <constraint type="testing">All security functions must have unit tests with >90% coverage.</constraint>
    <constraint type="integration">Security functions must integrate with User model's hashed_password field (str | None type).</constraint>
    <constraint type="coding-standards">Use type hints for all function signatures. Add comprehensive docstrings with examples.</constraint>
    <constraint type="error-handling">JWT verification must gracefully handle JWTError exceptions and return None for invalid tokens.</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>hash_password</name>
      <kind>function</kind>
      <signature>def hash_password(password: str) -> str</signature>
      <path>backend/src/core/security.py</path>
      <description>Hash a plain text password using bcrypt with cost factor 12. Returns UTF-8 encoded hash string.</description>
    </interface>
    <interface>
      <name>verify_password</name>
      <kind>function</kind>
      <signature>def verify_password(plain_password: str, hashed_password: str) -> bool</signature>
      <path>backend/src/core/security.py</path>
      <description>Verify a plain password against a bcrypt hash. Returns True if match, False otherwise.</description>
    </interface>
    <interface>
      <name>create_access_token</name>
      <kind>function</kind>
      <signature>def create_access_token(data: dict, expires_delta: timedelta | None = None) -> str</signature>
      <path>backend/src/core/security.py</path>
      <description>Create a JWT access token with HS256 algorithm. Default expiry: 15 minutes. Returns JWT string.</description>
    </interface>
    <interface>
      <name>verify_access_token</name>
      <kind>function</kind>
      <signature>def verify_access_token(token: str) -> dict | None</signature>
      <path>backend/src/core/security.py</path>
      <description>Verify and decode a JWT token. Returns payload dict if valid, None if invalid/expired.</description>
    </interface>
    <interface>
      <name>User.hashed_password</name>
      <kind>model-field</kind>
      <signature>hashed_password: str | None = Field(default=None)</signature>
      <path>backend/src/models/user.py</path>
      <description>User model field for storing bcrypt hashed passwords. Nullable for OAuth users without passwords.</description>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Testing framework: pytest (already installed in dev dependencies).
      Test structure: Create tests in backend/tests/core/test_security.py matching src structure.
      Test classes: TestPasswordHashing for hash/verify functions, TestJWTTokens for token functions.
      Coverage requirement: Minimum 90% code coverage for security.py module.
      Test edge cases: Empty strings, None values, special characters, expired tokens, invalid tokens.
      Run tests: uv run pytest tests/core/test_security.py -v
      Full suite: uv run pytest to ensure no regressions.
    </standards>
    <locations>
      <location>backend/tests/core/test_security.py</location>
      <location>backend/tests/core/__init__.py</location>
    </locations>
    <ideas>
      <test mapped-to="AC2">test_hash_password_creates_bcrypt_hash - Verify output is valid bcrypt hash format</test>
      <test mapped-to="AC2">test_hash_password_different_each_time - Same password generates different hashes (salt randomness)</test>
      <test mapped-to="AC2">test_hash_password_handles_special_characters - Test with special chars like !@#$%</test>
      <test mapped-to="AC3">test_verify_password_correct_password - Matching password returns True</test>
      <test mapped-to="AC3">test_verify_password_incorrect_password - Non-matching password returns False</test>
      <test mapped-to="AC3">test_verify_password_handles_special_characters - Verify special chars work correctly</test>
      <test mapped-to="AC4">test_create_access_token_with_default_expiry - Token has 15 min expiry</test>
      <test mapped-to="AC4">test_create_access_token_with_custom_expiry - Token respects custom expiry</test>
      <test mapped-to="AC4">test_create_access_token_includes_exp_claim - Payload contains exp field</test>
      <test mapped-to="AC5">test_verify_access_token_valid_token - Valid token returns payload dict</test>
      <test mapped-to="AC5">test_verify_access_token_expired_token - Expired token returns None</test>
      <test mapped-to="AC5">test_verify_access_token_invalid_token - Invalid signature returns None</test>
      <test mapped-to="AC5">test_verify_access_token_malformed_token - Malformed string returns None</test>
      <test mapped-to="AC8">test_integration_hash_verify_roundtrip - End-to-end test: hash then verify</test>
      <test mapped-to="AC8">test_integration_token_create_verify_roundtrip - End-to-end test: create then verify token</test>
    </ideas>
  </tests>
</story-context>
